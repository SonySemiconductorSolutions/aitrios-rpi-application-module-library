"use strict";(self.webpackChunkmodlib_docs=self.webpackChunkmodlib_docs||[]).push([[7436],{2747:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"examples/calculate","title":"Calculate","description":"The Calculate module is designed to contain components focused around calculating values for applications. It contains SpeedCalculator, a class focused on calculating the speed of tracked objects over time by calculating the change in distance over time. Also contains angle calculation, a function to calculate the angle between 3 keypoints values. Finally a few small functions to calculate the distance between two points in 2D pixel space and a function to calculate the center point of a bbox/4 points.","source":"@site/_docs_versioned_docs/version-1.2.0/examples/calculate.md","sourceDirName":"examples","slug":"/examples/calculate","permalink":"/en/application-module-library/docs/examples/calculate","draft":false,"unlisted":false,"tags":[],"version":"1.2.0","sidebarPosition":5,"frontMatter":{"title":"Calculate","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Heatmap","permalink":"/en/application-module-library/docs/examples/heatmap"},"next":{"title":"Blur","permalink":"/en/application-module-library/docs/examples/blur"}}');var c=a(4848),o=a(8453),l=a(6036);const s={title:"Calculate",sidebar_position:5},i="Calculate",r={},d=[{value:"SpeedCalculator",id:"speedcalculator",level:2},{value:"Distance Calculator",id:"distance-calculator",level:2}];function p(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(t.header,{children:(0,c.jsx)(t.h1,{id:"calculate",children:"Calculate"})}),"\n",(0,c.jsxs)(t.p,{children:["The ",(0,c.jsx)(l.A,{to:"/api-reference/apps/calculate",children:"Calculate"})," module is designed to contain components focused around calculating values for applications. It contains SpeedCalculator, a class focused on calculating the speed of tracked objects over time by calculating the change in distance over time. Also contains angle calculation, a function to calculate the angle between 3 keypoints values. Finally a few small functions to calculate the distance between two points in 2D pixel space and a function to calculate the center point of a bbox/4 points."]}),"\n",(0,c.jsx)(t.h2,{id:"speedcalculator",children:"SpeedCalculator"}),"\n",(0,c.jsx)(t.p,{children:"The SpeedCalculator can be used to calulate the speed of objects, such as:"}),"\n",(0,c.jsxs)(t.ul,{children:["\n",(0,c.jsx)(t.li,{children:"Calculating the speed of traffic."}),"\n",(0,c.jsx)(t.li,{children:"Calculating the speed of objects for sports games."}),"\n"]}),"\n",(0,c.jsxs)(t.p,{children:["The SpeedCalculator required the use of a tracker, such as ",(0,c.jsx)(t.a,{href:"/en/application-module-library/docs/examples/tracker",children:"BYTETracker"})," to track objects over time."]}),"\n",(0,c.jsx)(t.p,{children:(0,c.jsx)(t.img,{alt:"Speed",src:a(1604).A+"",width:"800",height:"450"})}),"\n",(0,c.jsx)(t.p,{children:"Below an example of how one can use the SpeedCalculator in the Application Module Library."}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-python",metastring:'title="speed_calc.py"',children:'import numpy as np \nfrom modlib.apps import Annotator, ColorPalette, BYTETracker\nfrom modlib.apps.calculate import SpeedCalculator\nfrom modlib.devices import AiCamera\nfrom modlib.models.zoo import NanoDetPlus416x416\n\nclass BYTETrackerArgs:\n\ttrack_thresh: float = 0.30\n\ttrack_buffer: int = 30\n\tmatch_thresh: float = 0.8\n\taspect_ratio_thresh: float = 3.0\n\tmin_box_area: float = 1.0\n\tmot20: bool = False\n\nmodel = NanoDetPlus416x416()\ndevice = AiCamera()\ndevice.deploy(model)\n\ndistance_per_pixel = 0.00742 # Need to recalibrate when camera is repositioned\ntracker = BYTETracker(BYTETrackerArgs())\nspeed = SpeedCalculator()\nannotator = Annotator(color=ColorPalette.default(), thickness=1, text_thickness=1, text_scale=0.4)\n\nwith device as stream:\n\tfor frame in stream:\n\t\tdetections = frame.detections[frame.detections.confidence > 0.50]\n\t\tdetections = tracker.update(frame, detections)\n\t\t\n\t\t# Calculate and retrieve speed per tracked object.\n\t\tspeed.calculate(frame, detections)\n\t\tcurrent_speeds = [speed.get_speed(t, average=False) for t in detections.tracker_id]\n\t\t\n\t\tlabels = [f"{s*distance_per_pixel*3.6:0.2f}kph" if s is not None else "..." for s in current_speeds]\n\t\tframe.image = annotator.annotate_boxes(frame=frame, detections=detections, labels=labels)\n\t\tframe.display()\n'})}),"\n",(0,c.jsx)(t.h2,{id:"distance-calculator",children:"Distance Calculator"}),"\n",(0,c.jsx)(t.p,{children:"Distance Calculator can be used to calculate the distance between objects. It returns the distance in pixels. To convert to real world values you can use multiple by a factor where 1 pixel is a certain distance. speed_cal.py does this to convert from pixels per hour to kph."}),"\n",(0,c.jsx)(t.p,{children:(0,c.jsx)(t.img,{alt:"Distance",src:a(4574).A+"",width:"800",height:"450"})}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-python",metastring:'title="distance.py"',children:'import cv2\nimport numpy as np\n\nfrom modlib.apps import Annotator, ColorPalette\nfrom modlib.apps.calculate import calculate_distance_matrix\nfrom modlib.devices import AiCamera\nfrom modlib.models.zoo import NanoDetPlus416x416\n\nmodel = NanoDetPlus416x416()\ndevice = AiCamera()\ndevice.deploy(model)\n\nannotator = Annotator(color=ColorPalette.default(), thickness=1, text_thickness=1, text_scale=0.4)\n\nwith device as stream:\n\tfor frame in stream:\n\t\tdetections = frame.detections[frame.detections.confidence > 0.50]\n\n\t\t# Calculate distance matrix\n\t\txc, yc = detections.center_points\n\t\txc, yc = xc*frame.width, yc*frame.height\n\t\tdist_matrix = calculate_distance_matrix(xc, yc)\n\n\t\t# Display distance to each objects\n\t\tindeces = np.triu_indices(len(xc), k=1)\n\t\tfor i, j in zip(*indeces):\n\t\t\tdistance = dist_matrix[i, j]\n\t\t\tp1 = (int(xc[i]), int(yc[i]))\n\t\t\tp2 = (int(xc[j]), int(yc[j]))\n\n\t\t\tcv2.line(frame.image, p1, p2, (255, 255, 255), 1)\n\t\t\tcv2.putText(frame.image, f"{distance:.1f}", ((p1[0] + p2[0]) // 2, (p1[1] + p2[1]) // 2), cv2.FONT_HERSHEY_SIMPLEX, 0.8, (255, 255, 0), 2)\n\n\t\tlabels = [f"{model.labels[class_id]}: {score:0.2f}" for _, score, class_id, _ in detections]\n\t\tframe.image = annotator.annotate_boxes(frame=frame, detections=detections, labels=labels)\n\n\t\tframe.display()\n'})})]})}function u(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,c.jsx)(t,{...e,children:(0,c.jsx)(p,{...e})}):p(e)}},6036:(e,t,a)=>{a.d(t,{A:()=>s});a(6540);var n=a(8774),c=a(3025),o=a(4070),l=a(4848);function s({to:e,children:t,...a}){const s=(0,c.r)("_docs")?.label||"latest",i=(0,o.ir)("_docs"),r=i?.isLast;let d=e;return e.startsWith("/api-reference/")&&(r||(d=`/api-reference/${s}${e.replace("/api-reference","")}`)),(0,l.jsx)(n.A,{to:d,...a,children:t})}},4574:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/distance.gif"},1604:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/speed.gif"},8453:(e,t,a)=>{a.d(t,{R:()=>l,x:()=>s});var n=a(6540);const c={},o=n.createContext(c);function l(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:l(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);